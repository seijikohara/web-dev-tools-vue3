name: Playwright E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: E2E Tests
    timeout-minutes: 60
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Run tests in parallel shards for faster execution
        shard: [1, 2, 3, 4]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24.x
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        run: npx playwright test --shard=${{ matrix.shard }}/${{ strategy.job-total }}

      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v5
        with:
          name: playwright-report-${{ matrix.shard }}
          path: playwright-report/
          retention-days: 30

      - name: Upload test artifacts
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v5
        with:
          name: test-results-${{ matrix.shard }}
          path: test-results/
          retention-days: 30

  # Dependency update regression testing
  # Runs when commit message contains 'deps:' or 'dependencies'
  dependency-regression-test:
    name: Dependency Regression Test
    if: contains(github.event.head_commit.message, 'deps:') || contains(github.event.head_commit.message, 'dependencies') || contains(github.event.head_commit.message, 'upgrade')
    timeout-minutes: 90
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Test all browsers for dependency updates
        browser: [chromium, firefox, webkit]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24.x
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Run full regression test on ${{ matrix.browser }}
        run: npx playwright test --project=${{ matrix.browser }}

      - name: Upload browser test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v5
        with:
          name: regression-report-${{ matrix.browser }}
          path: playwright-report/
          retention-days: 30

      - name: Upload browser test artifacts
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v5
        with:
          name: regression-results-${{ matrix.browser }}
          path: test-results/
          retention-days: 30

  # Report test results
  report:
    name: Test Report
    if: ${{ !cancelled() }}
    needs: [test]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-reports

      - name: Display structure of downloaded files
        run: ls -R all-reports

      - name: Check test results
        run: |
          echo "E2E tests completed. Check artifacts for detailed reports."
          if [ -d "all-reports" ]; then
            echo "Test reports available in artifacts."
          fi
